--- 
layout: post
comments: true
title: !binary |
  bGlua190b+S4reeahOWwj+eUnOeCuQ==

date: 2008-1-30
link: false
categories: life
---
<p>升级後技能云的<a href="http://www.itechtag.com/companies">公司展示页面</a>出现一个<a href="http://code.google.com/p/itechtag/issues/detail?id=49">很奇怪的问题</a>，一直报告说：</p>
{% codeblock %}ActionView::TemplateError (undefined method `[]' for nil:NilClass)<br />on line #57 of companies/_cannot_edit_item.rhtml:<br />而这行却是没有代码的，真的奇怪的很。翻遍这个文件也没有发现什么可疑的地方，最后<br />没有办法就挨个的测试，发现有的公司展示页面是可以的，进数据库比较不同，发现有些<br />字段是没有值的，难道这个问题，于是挨个的加上值，测试，果然通过，后来再仔细看看<br />错误信息：<div class="codeText"><div class="codeHead">错误日志</div><ol start="1" class="dp-xml"><li class="alt"><span><span>vendor/rails/actionpack/lib/action_controller/url_rewriter.rb:96:in&nbsp;`rewrite_url'&nbsp;&nbsp;</span></span></li><li class=""><span>vendor/rails/actionpack/lib/action_controller/url_rewriter.rb:82:in&nbsp;`rewrite'&nbsp;&nbsp;</span></li><li class="alt"><span>vendor/rails/actionpack/lib/action_controller/base.rb:620:in&nbsp;`url_for'&nbsp;&nbsp;</span></li><li class=""><span>vendor/rails/actionpack/lib/action_view/helpers/url_helper.rb:76:in&nbsp;`send'&nbsp;&nbsp;</span></li><li class="alt"><span>vendor/rails/actionpack/lib/action_view/helpers/url_helper.rb:76:in&nbsp;`url_for'&nbsp;&nbsp;</span></li><li class=""><span>vendor/rails/actionpack/lib/action_view/helpers/url_helper.rb:144:in&nbsp;`link_to'&nbsp;&nbsp;</span></li><li class="alt"><span>app/views/companies/_cannot_edit_item.rhtml:57:in&nbsp;&nbsp;</span></li><li class=""><span>n_erb_47app47views47companies47_cannot_edit_item46rhtml'&nbsp;&nbsp;</span></li></ol></div>看到<strong><span>url_for</span></strong>的身影，突然感觉到是那个公司地址的问题，再测，果然，如此，看看我的代码是这么写的》<br /><div class="codeText"><div class="codeHead">XML/HTML代码</div><ol start="1" class="dp-xml"><li class="alt"><span><span class="tag">&lt;</span><span>%=&nbsp;link_to&nbsp;website.link_url,&nbsp;website.link_url&nbsp;%</span><span class="tag">&gt;</span><span>&nbsp;&nbsp;</span></span></li></ol></div>也就是，生成链接地址，但是当遇到这个字段为空的时候，就挂了，也就是上面这个错误的原因了。<br /><br />查看了下<strong>link_to </strong>的源代码，如下：<br /><div class="codeText"><div class="codeHead">link_to代码</div><ol start="1" class="dp-rb"><li class="alt"><span><span>137&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword">def</span><span>&nbsp;link_to(name,&nbsp;options&nbsp;=&nbsp;{},&nbsp;html_options&nbsp;=&nbsp;</span><span class="keyword">nil</span><span>)&nbsp;&nbsp;</span></span></li><li class=""><span>138&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url&nbsp;=&nbsp;<span class="keyword">case</span><span>&nbsp;options&nbsp;&nbsp;</span></span></li><li class="alt"><span>139&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">when</span><span>&nbsp;</span><span class="builtin">String</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>140&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options&nbsp;&nbsp;</span></li><li class="alt"><span>141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">when</span><span>&nbsp;</span><span class="symbol">:back</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>142&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable">@controller</span><span>.request.env[</span><span class="string">&quot;HTTP_REFERER&quot;</span><span>]&nbsp;||&nbsp;</span><span class="string">'javascript:history.back()'</span><span>&nbsp;&nbsp;</span></span></li><li class="alt"><span>143&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>144&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">self</span><span>.<font color="#ff0000">url_for</font>(options)&nbsp;&nbsp;</span></span></li><li class="alt"><span>145&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>146&nbsp;&nbsp;&nbsp;</span></li><li class="alt"><span>147&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span><span>&nbsp;html_options&nbsp;&nbsp;</span></span></li><li class=""><span>148&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;html_options&nbsp;=&nbsp;html_options.stringify_keys&nbsp;&nbsp;</span></li><li class="alt"><span>149&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;href&nbsp;=&nbsp;html_options[<span class="string">'href'</span><span>]&nbsp;&nbsp;</span></span></li><li class=""><span>150&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;convert_options_to_javascript!(html_options,&nbsp;url)&nbsp;&nbsp;</span></li><li class="alt"><span>151&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tag_options&nbsp;=&nbsp;tag_options(html_options)&nbsp;&nbsp;</span></li><li class=""><span>152&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><span>&nbsp;&nbsp;</span></span></li><li class="alt"><span>153&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tag_options&nbsp;=&nbsp;<span class="keyword">nil</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>154&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li class="alt"><span>155&nbsp;&nbsp;&nbsp;</span></li><li class=""><span>156&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;href_attr&nbsp;=&nbsp;<span class="string">&quot;href=\&quot;#{url}\&quot;&quot;</span><span>&nbsp;</span><span class="keyword">unless</span><span>&nbsp;href&nbsp;&nbsp;</span></span></li><li class="alt"><span>157&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">&quot;&lt;a&nbsp;#{href_attr}#{tag_options}&gt;#{name&nbsp;||&nbsp;url}&lt;/a&gt;&quot;</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>158&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li></ol></div>接着跟，如下：<div class="codeText"><div class="codeHead">url_for代码</div><ol start="1" class="dp-rb"><li class="alt"><span><span>65&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword">def</span><span>&nbsp;url_for(options&nbsp;=&nbsp;{})&nbsp;&nbsp;</span></span></li><li class=""><span>66&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">case</span><span>&nbsp;options&nbsp;&nbsp;</span></span></li><li class="alt"><span>67&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">when</span><span>&nbsp;</span><span class="builtin">Hash</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>68&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;show_path&nbsp;=&nbsp;&nbsp;options[<span class="symbol">:host</span><span>].</span><span class="keyword">nil</span><span>?&nbsp;?&nbsp;</span><span class="keyword">true</span><span>&nbsp;:&nbsp;</span><span class="keyword">false</span><span>&nbsp;&nbsp;</span></span></li><li class="alt"><span>69&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options&nbsp;=&nbsp;{&nbsp;<span class="symbol">:only_path</span><span>&nbsp;=&gt;&nbsp;show_path&nbsp;}.update(options.symbolize_keys)&nbsp;&nbsp;</span></span></li><li class=""><span>70&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;escape&nbsp;&nbsp;=&nbsp;options.key?(<span class="symbol">:escape</span><span>)&nbsp;?&nbsp;options.delete(</span><span class="symbol">:escape</span><span>)&nbsp;:&nbsp;</span><span class="keyword">true</span><span>&nbsp;&nbsp;</span></span></li><li class="alt"><span>71&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;<span class="variable">@controller</span><span>.send(</span><span class="symbol">:url_for</span><span>,&nbsp;options)&nbsp;&nbsp;</span></span></

li><li class=""><span>72&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">when</span><span>&nbsp;</span><span class="builtin">String</span><span>&nbsp;&nbsp;</span></span></li><li class="alt"><span>73&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;escape&nbsp;=&nbsp;<span class="keyword">true</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>74&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;options&nbsp;&nbsp;</span></li><li class="alt"><span>75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">when</span><span>&nbsp;</span><span class="builtin">NilClass</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>76&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url&nbsp;=&nbsp;<span class="variable">@controller</span><span>.send(</span><span class="symbol">:url_for</span><span>,&nbsp;</span><span class="keyword">nil</span><span>)&nbsp;&nbsp;</span></span></li><li class="alt"><span>77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>78&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;escape&nbsp;=&nbsp;<span class="keyword">false</span><span>&nbsp;&nbsp;</span></span></li><li class="alt"><span>79&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;polymorphic_path(options)&nbsp;&nbsp;</span></li><li class=""><span>80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li><li class="alt"><span>81&nbsp;&nbsp;&nbsp;</span></li><li class=""><span>82&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;escape&nbsp;?&nbsp;escape_once(url)&nbsp;:&nbsp;url&nbsp;&nbsp;</span></li><li class="alt"><span>83&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><span>&nbsp;&nbsp;</span></span></li></ol></div>原来如此，豁然开朗。另外还看到:back这样的link_to用法，:){% endcodeblock %}
